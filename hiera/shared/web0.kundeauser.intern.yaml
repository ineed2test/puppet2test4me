---

classes:
#  - mycertfilemanagement
  - apache
  - apache::mod::alias
  - apache::mod::jk
  - apache::mod::security
#admins:
#  dreck11:
#    sshkeys:
#      - AAAAB3NzaC1yc2EAAAADAQABAAABAQC1lZU7S+1n7lXxK04d68NK3IMQ5SHryWNN73BPo5ZzkQFY8Hv1F9cUEVGB7RR4XTEp0jTJzk9L00Bx6wPuROTG/sH+6ksNw32/cp+gVxF05oPpqJcGV52m3sH3uZvFAuTzY+3RJwmXk1/2WeSPPd2qDA74/6bkBjDUglQLFnyMi51hbHx3qKjXZDnzUmuVnLS472NoGVb00vxKZUU/PLCk65P50VXZhwW8augySsIjZ0olUrwmlR/vcZ7mS7kyWb1QsP31BmUQAEH5MwJ2s236F2re3O5DF8bEjsfVKRXETV1WOLHIg/6625Tu3o2OBjdpXxq/RQNpdxwd2x4upCGw
#    password: '!'
#    uid: '1126'

# malfunction
#apache::mod::jk:
#  ip: '192.168.2.15'
#  workers_file_content:
#    - 'worker.list=workerkundea'
#  workers_file: /etc/workers.properties
#  port: '9081'

# mod_jk installation.
packages:
  libapache2-mod-jk:
    ensure: present
#    puppet:///modules/<MODULE NAME>/<FILE PATH>
files:
  '/etc/libapache2-mod-jk/workers.properties':
    source: 'puppet:///modules/kundea/workers.properties'
#  mode: '0777'
#  owner: 'dreck11'
#  group: 'dreck11'

# diverse apache settings
apache::mpm_module: prefork
apache::server_tokens: Prod
apache::server_signature: 'Off'
apache::trace_enable: 'Off'
apache::error_documents: true
apache::default_vhost: false

# modsecurity
apache::mod::security::secdefaultaction: 'pass'
apache::mod::security::activated_rules:
  - 'base_rules/modsecurity_35_bad_robots.data'
  - 'base_rules/modsecurity_35_scanners.data'
  - 'base_rules/modsecurity_40_generic_attacks.data'
  - 'base_rules/modsecurity_41_sql_injection_attacks.data'
  - 'base_rules/modsecurity_50_outbound.data'
  - 'base_rules/modsecurity_50_outbound_malware.data'
  - 'base_rules/modsecurity_crs_20_protocol_violations.conf'
  - 'base_rules/modsecurity_crs_21_protocol_anomalies.conf'
  - 'base_rules/modsecurity_crs_23_request_limits.conf'
  - 'base_rules/modsecurity_crs_30_http_policy.conf'
  - 'base_rules/modsecurity_crs_35_bad_robots.conf'
  - 'base_rules/modsecurity_crs_40_generic_attacks.conf'
  - 'base_rules/modsecurity_crs_41_sql_injection_attacks.conf'
  - 'base_rules/modsecurity_crs_41_xss_attacks.conf'
  - 'base_rules/modsecurity_crs_42_tight_security.conf'
  - 'base_rules/modsecurity_crs_45_trojans.conf'
  - 'base_rules/modsecurity_crs_47_common_exceptions.conf'
  - 'base_rules/modsecurity_crs_49_inbound_blocking.conf'
  - 'base_rules/modsecurity_crs_50_outbound.conf'
  - 'base_rules/modsecurity_crs_59_outbound_blocking.conf'
  - 'base_rules/modsecurity_crs_60_correlation.conf'
  - 'base_rules/modsecurity_crs_61_kundea_rule.conf'

#apache::mod::jk:
#  workers_file: '/etc/workers.properties'
#    workers_file_content:
#       worker_lists: workerkundea
#       some_name:
#         port: 8009
#         type: ajp13
#         host: localhost
apache::vhost:
  'www.kundea.local':
    vhost_name: '*'
    serveraliases: 'm.kundea.local'
    port: 81
    aliases:
      -
        alias: /media/foto 
        path: /home/kundea/upload/foto 
      -
        alias: /media/docs 
        path: /home/kundea/upload/docs
    docroot: '/var/www/'
    docroot_owner: www-data
    docroot_group: www-data
    options: '-Indexes -FollowSymLinks -MultiViews'
    rewrites:
          # Need to enquote percent sign in dirty way
          # See https://tickets.puppetlabs.com/browse/HI-127
      - rewrite_rule: "^/?(.*) https://%%{THIS_DOESNT_EXIST}{SERVER_NAME}/$1 [R=301,L]"
        rewrite_cond: "%%{THIS_DOESNT_EXIST}{HTTP:X-Forwarded-Proto} ^http$"

      - rewrite_rule: ^(.*)$ https://m.kundea.de/kundea/mobile$1 [R=301,L]
        rewrite_cond: "%%{THIS_DOESNT_EXIST}{HTTP:X-Forwarded-Proto} ^http$"
    jk_mounts:
      -
        mount: /kundea
        worker: workerkundea
      -
        mount: /kundea/*
        worker: workerkundea
      -
        unmount: /kundea/css/*
        worker: workerkundea
