---

classes:
#  - mycertfilemanagement
  - apache
  - apache::mod::alias
  - apache::mod::jk
  - apache::mod::security
  - tomcat
  - archive
#admins:
#  dreck11:
#    sshkeys:
#      - AAAAB3NzaC1yc2EAAAADAQABAAABAQC1lZU7S+1n7lXxK04d68NK3IMQ5SHryWNN73BPo5ZzkQFY8Hv1F9cUEVGB7RR4XTEp0jTJzk9L00Bx6wPuROTG/sH+6ksNw32/cp+gVxF05oPpqJcGV52m3sH3uZvFAuTzY+3RJwmXk1/2WeSPPd2qDA74/6bkBjDUglQLFnyMi51hbHx3qKjXZDnzUmuVnLS472NoGVb00vxKZUU/PLCk65P50VXZhwW8augySsIjZ0olUrwmlR/vcZ7mS7kyWb1QsP31BmUQAEH5MwJ2s236F2re3O5DF8bEjsfVKRXETV1WOLHIg/6625Tu3o2OBjdpXxq/RQNpdxwd2x4upCGw
#    password: '!'
#    uid: '1126'

# malfunction
#apache::mod::jk:
#  ip: '192.168.2.15'
#  workers_file_content:
#    - 'worker.list=workerkundea'
#  workers_file: /etc/workers.properties
#  port: '9081'

#host:
#  www1:
#    name: deb03.localdomain
#    ip: 192.168.1.10
#    ensure: present

# create user kundea without ssh access and password and home directory !!! user kundea is already create by tomcat::install
#users:
#  user1:
#    name: kundea
#    home: /home/kundea
#    uid: 4711
#    ensure: present
#    shell: /bin/bash
#files:
#  '/home/kundea':
#    ensure: directory
#    path: /home/kundea
#    owner: kundea
#    group: kundea
#    mode: '0755'

# Packages Installation
# mod_jk + openjdk 7
packages:
  libapache2-mod-jk:
    ensure: present

  openjdk-8-jdk:
    ensure: present

# service running to start at systemboot
services:
  tomcat:
    ensure: true
    enable: true

#    puppet:///modules/<MODULE NAME>/<FILE PATH>
files:
  '/etc/libapache2-mod-jk/workers.properties':
    source: 'puppet:///modules/kundea/workers.properties'
    mode:  u=rwx,g=rw,o=rw
    owner: root
    group: root

  '/home/kundea/tomcat/conf/server.xml':
    source: 'puppet:///modules/kundea/server.xml'
    mode:  u=rwx,g=rw,o=rw
    owner: kundea
    group: kundea

  '/lib/systemd/system/tomcat.service':
    source: 'puppet:///modules/kundea/tomcat-systemd-unit'
    mode:  u=rwx,g=rw,o=rw
    owner: root
    group: root

  '/etc/systemd/system/multi-user.target.wants/tomcat.service':
    ensure: link
    target: lib/systemd/system/tomcat.service

  '/home/kundea':
    ensure: directory
    path: /home/kundea
    owner: kundea
    group: kundea
    mode:  ugo=rwx
# diverse apache settings
apache::mpm_module: prefork
apache::server_tokens: Prod
apache::server_signature: 'Off'
apache::trace_enable: 'Off'
#apache::error_documents: true
apache::default_vhost: false

# modsecurity
apache::mod::security::secdefaultaction: 'pass'
apache::mod::security::activated_rules:
  - 'rules/crawlers-user-agents.data'
  - 'rules/iis-errors.data'
  - 'rules/java-code-leakages.data'
  - 'rules/java-errors.data'
  - 'rules/lfi-os-files.data'
  - 'rules/php-config-directives.data'
  - 'rules/php-errors.data'
  - 'rules/php-function-names-933150.data'
  - 'rules/php-function-names-933151.data'
  - 'rules/php-variables.data'
  - 'rules/REQUEST-901-INITIALIZATION.conf'
  - 'rules/REQUEST-903.9001-DRUPAL-EXCLUSION-RULES.conf'
  - 'rules/REQUEST-903.9002-WORDPRESS-EXCLUSION-RULES.conf'
  - 'rules/REQUEST-905-COMMON-EXCEPTIONS.conf'
  - 'rules/REQUEST-910-IP-REPUTATION.conf'
  - 'rules/REQUEST-911-METHOD-ENFORCEMENT.conf'
  - 'rules/REQUEST-912-DOS-PROTECTION.conf'
# Syntax Error  Syntax error on line 59 of /etc/modsecurity/activated_rules/REQUEST-913-SCANNER-DETECTION.conf
#  - 'rules/REQUEST-913-SCANNER-DETECTION.conf'
  - 'rules/REQUEST-920-PROTOCOL-ENFORCEMENT.conf'
  - 'rules/REQUEST-921-PROTOCOL-ATTACK.conf'
  - 'rules/REQUEST-930-APPLICATION-ATTACK-LFI.conf'
  - 'rules/REQUEST-931-APPLICATION-ATTACK-RFI.conf'
  - 'rules/REQUEST-932-APPLICATION-ATTACK-RCE.conf'
  - 'rules/REQUEST-933-APPLICATION-ATTACK-PHP.conf'
  - 'rules/REQUEST-941-APPLICATION-ATTACK-XSS.conf'
  - 'rules/REQUEST-942-APPLICATION-ATTACK-SQLI.conf'
  - 'rules/REQUEST-943-APPLICATION-ATTACK-SESSION-FIXATION.conf'
  - 'rules/REQUEST-949-BLOCKING-EVALUATION.conf'
  - 'rules/RESPONSE-950-DATA-LEAKAGES.conf'
  - 'rules/RESPONSE-951-DATA-LEAKAGES-SQL.conf'
  - 'rules/RESPONSE-952-DATA-LEAKAGES-JAVA.conf'
  - 'rules/RESPONSE-953-DATA-LEAKAGES-PHP.conf'
  - 'rules/RESPONSE-954-DATA-LEAKAGES-IIS.conf'
  - 'rules/RESPONSE-959-BLOCKING-EVALUATION.conf'
  - 'rules/RESPONSE-980-CORRELATION.conf'
  - 'rules/restricted-files.data'
  - 'rules/scanners-headers.data'
  - 'rules/scanners-urls.data'
  - 'rules/scanners-user-agents.data'
  - 'rules/scripting-user-agents.data'
  - 'rules/sql-errors.data'
  - 'rules/sql-function-names.data'
  - 'rules/unix-shell.data'
  - 'rules/windows-powershell-commands.data'

#apache::mod::jk:
#  workers_file: '/etc/workers.properties'
#    workers_file_content:
#       worker_lists: workerkundea
#       some_name:
#         port: 8009
#         type: ajp13
#         host: localhost
apache::vhost:
  'www.kundea.local':
    vhost_name: '*'
    serveraliases: 'm.kundea.local'
    port: 81
    aliases:
      -
        alias: /media/foto 
        path: /home/kundea/upload/foto 
      -
        alias: /media/docs 
        path: /home/kundea/upload/docs
    docroot: '/var/www/'
    docroot_owner: www-data
    docroot_group: www-data
    options: '-Indexes -FollowSymLinks -MultiViews'
    rewrites:
          # Need to enquote percent sign in dirty way
          # See https://tickets.puppetlabs.com/browse/HI-127
      - rewrite_rule: "^/?(.*) https://%%{THIS_DOESNT_EXIST}{SERVER_NAME}/$1 [R=301,L]"
        rewrite_cond: "%%{THIS_DOESNT_EXIST}{HTTP:X-Forwarded-Proto} ^http$"

      - rewrite_rule: ^(.*)$ https://m.kundea.de/kundea/mobile$1 [R=301,L]
        rewrite_cond: "%%{THIS_DOESNT_EXIST}{HTTP:X-Forwarded-Proto} ^http$"
    jk_mounts:
      -
        mount: /kundea
        worker: workerkundea
      -
        mount: /kundea/*
        worker: workerkundea
      -
        unmount: /kundea/css/*
        worker: workerkundea

#tomcat
tomcat_install:
  '/home/kundea/tomcat':
    source_url: 'http://www-eu.apache.org/dist/tomcat/tomcat-7/v7.0.81/bin/apache-tomcat-7.0.81.tar.gz'
    user: kundea
    group: kundea
tomcat_instance:
  default:
    catalina_home: /home/kundea/tomcat
    user: kundea
    group: kundea
tomcat_config_server_connector:
  ajp:
    catalina_base: /home/kundea/tomcat
    connector_ensure: present
    port: '7081'
    protocol: 'AJP/1.3'
    purge_connectors: true
# additional_attributes must be set as hash
    additional_attributes:
# same value as apache maxrequestworkers, note that default 250 is per cpu core
      maxThreads: 750
      minSpareThreads: 150
      acceptCount: 200
      redirectPort: 8443
tomcat_config_server_tomcat_users:
  user1:
    catalina_base: /home/kundea/tomcat
    owner: kundea
    group: kundea
    element: user
    element_name: user1
    password: blah
    roles:
      - manager_gui

# exec important commands
execs:
  'usermod change user kundea UID':
    command: '/usr/sbin/service tomcat stop && /usr/sbin/groupmod -g 4711 kundea && /usr/sbin/usermod -u 4711 kundea && /usr/sbin/service tomcat start'
    user: root