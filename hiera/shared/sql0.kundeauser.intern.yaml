---

classes:

  - mysql::server
  - mysql::client::install
  - mysql::server::install
#  - mysql::db
  - rabbitmq
# solr tomcat
  - tomcat

packages:
  openjdk-8-jdk:
    ensure: present

files:
  '/lib/systemd/system/tomcat.service':
    source: 'puppet:///modules/kundea/tomcat-systemd-unit'
    mode:  u=rwx,g=rw,o=rw
    owner: root
    group: root

  '/etc/systemd/system/multi-user.target.wants/tomcat.service':
    ensure: link
    target: lib/systemd/system/tomcat.service

  #  '/home/kundea/tomcat/bin/setenv.sh':
  #    source: 'puppet:///modules/kundea/setenv.sh'
  #    mode:  u=rwx,g=rw,o=rw
  #    owner: root
  #    group: root



  '/home/kundea':
    ensure: directory
    path: /home/kundea
    owner: kundea
    group: kundea
    mode:  ugo=rwx

# tomcat solr
tomcat_install:
  '/home/kundea/tomcat':
    source_url: 'http://www-eu.apache.org/dist/tomcat/tomcat-7/v7.0.81/bin/apache-tomcat-7.0.81.tar.gz'
    catalina_home: /home/kundea/tomcat
    user: kundea
    group: kundea

tomcat_instance:
  default:
    catalina_home: /home/kundea/tomcat
    user: kundea
    group: kundea

tomcat_config_server_connector:
  http:
    catalina_base: /home/kundea/tomcat
    connector_ensure: present
    port: '7081'
    protocol: 'HTTP/1.1'
    purge_connectors: true

tomcat_war:
  'solr.war':
    war_ensure: present
    catalina_base: /home/kundea/tomcat
    war_source: puppet://modules/kundea/solr.war

mysql::server::package_name: mariadb-server
##mysql::server::package_endure: 5.7.11-4.1.el7
mysql::server::service_name: mariadb
mysql::server::root_password: blah
mysql::server::remove_default_accounts: false
mysql::server::override_options:
  'mysqld':
    bind-address: '0.0.0.0'
    expire_logs_days: '10'
    max_binlog_size: 100M
    log_slave_updates: '1'
    auto_increment_increment: '2'
    default-storage-engine: 'innodb'
    character-set-server: 'utf8mb4'
    collation-server: 'utf8mb4_general_ci'
    init-connect: 'SET NAMES utf8'
    lower_case_table_names: '1'
    log_bin: /var/log/mysql/mysql-bin.log
    max_connections: '75'
    query_cache_size: 256M
    key_buffer_size: 32M
    innodb_buffer_pool_size: 256M
    innodb_print_all_deadlocks: 'ON'
    slow_query_log: 'ON'
    general_log_file: '/var/lib/mysql/sql01.log'
mysql::server::databases:
  'kundea':
    ensure: present
    charset: utf8
mysql::server::users:
  'kurt@%':
    ensure: present
# convert with sql command
# MariaDB [(none)]> SELECT PASSWORD('pwkundea');
    password_hash: '*4553641D99805ACAE38C64D2F2CB1357E85FC2B3'
mysql::server::grants:
  'kurt@%/kundea.*':
    ensure: present
    options:
      - GRANT
    privileges:
      - all
    table: kundea.*
    user: kurt@%

#mysql::db:
#  'kundea1':
#    user: kurt
#    password: pwkurt
#    dbname: kundea
#    host: '%'
#    grant: ALL
rabbitmq:
  'myrabbitmq':
    port: 5672